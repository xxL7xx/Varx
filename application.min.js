class haste_document{constructor(a){this.locked=false;this.app=a}htmlEscape(a){return a.replace(/&/g,"&amp;").replace(/>/g,"&gt;").replace(/</g,"&lt;").replace(/"/g,"&quot;")}load(a,b,c){let d=this;$.ajax(`${d.app.baseUrl}documents/${a}`,{type:"get",dataType:"json",success:function(e){d.locked=true;d.key=a;d.data=e.data;let f;try{if(c=="txt"){f={value:d.htmlEscape(e.data)}}else if(c){f=hljs.highlight(c,e.data)}else{f=hljs.highlightAuto(e.data)}}catch(a){f=hljs.highlightAuto(e.data)}b({value:f.value,key:a,language:f.language||c,lineCount:e.data.split("\n").length})},error:function(){b(false)}})}save(a,b){if(this.locked)return false;this.data=a;let c=this;$.ajax(`${c.app.baseUrl}documents`,{type:"post",data:a,dataType:"json",contentType:"application/json; charset=utf-8",success:function(d){c.locked=true;c.key=d.key;let e=hljs.highlightAuto(a);b(null,{value:e.value,key:d.key,language:e.language,lineCount:a.split("\n").length})},error:function(a){try{b($.parseJSON(a.responseText))}catch(a){b({message:"Something went wrong!"})}}})}}class haste{constructor(a,b){this.appName=a;this.$textarea=$("textarea");this.$box=$("#box");this.$code=$("#box code");this.$linenos=$("#linenos");this.options=b;this.configureShortcuts();this.configureButtons();if(!b.twitter)$("#box2 .twitter").hide();this.baseUrl=b.baseUrl||"/"}setTitle(a){document.title=`${this.appName}${a?` - ${a}`:""}`}showMessage(a,b){let c=$(`<li class="${b||"info"}">${a}</li>`);$("#messages").prepend(c);setTimeout(function(){c.slideUp("fast",function(){$(this).remove()})},3000)}lightKey(){this.configureKey(["new","save"])}fullKey(){this.configureKey(["new","duplicate","twitter","raw"])}configureKey(a){let b;$("#box2 .function").each(function(){b=$(this);for(const c of a){if(b.hasClass(c)){b.addClass("enabled");return true}}b.removeClass("enabled")})}newDocument(a){this.$box.hide();this.doc=new haste_document(this);if(!a){window.history.pushState(null,this.appName,this.baseUrl)}this.setTitle();this.lightKey();this.$textarea.val("").show("fast",function(){this.focus()});this.removeLineNumbers()}lookupExtensionByType(a){for(let b in haste.extensionMap){if(haste.extensionMap[b]==a)return b}return a}lookupTypeByExtension(a){return haste.extensionMap[a]||a}addLineNumbers(a){let b="";for(let c=0;c<a;c++){b+=(c+1).toString()+"<br/>"}$("#linenos").html(b)}removeLineNumbers(){$("#linenos").html("&gt;")}loadDocument(a){let b=a.split(".",2);let c=this;c.doc=new haste_document(this);c.doc.load(b[0],function(a){if(a){c.$code.html(a.value);c.setTitle(a.key);c.fullKey();c.$textarea.val("").hide();c.$box.show().focus();c.addLineNumbers(a.lineCount)}else{c.newDocument()}},this.lookupTypeByExtension(b[1]))}duplicateDocument(){if(this.doc.locked){let a=this.doc.data;this.newDocument();this.$textarea.val(a)}}lockDocument(){let a=this;this.doc.save(this.$textarea.val(),function(b,c){if(b){a.showMessage(b.message,"error")}else if(c){a.$code.html(c.value);a.setTitle(c.key);let b=a.baseUrl+c.key;if(c.language){b+=`.${a.lookupExtensionByType(c.language)}`}window.history.pushState(null,`${a.appName}-${c.key}`,b);a.fullKey();a.$textarea.val("").hide();a.$box.show().focus();a.addLineNumbers(c.lineCount)}})}configureButtons(){let a=this;this.buttons=[{$where:$("#box2 .save"),label:"Save",shortcutDescription:"control + s",shortcut:function(a){return a.ctrlKey&&a.keyCode==83},action:function(){if(a.$textarea.val().replace(/^\s+|\s+$/g,"")!=""){a.lockDocument()}}},{$where:$("#box2 .new"),label:"New",shortcut:function(a){return a.ctrlKey&&a.keyCode==78},shortcutDescription:"control + n",action:function(){a.newDocument(!a.doc.key)}},{$where:$("#box2 .duplicate"),label:"Duplicate & Edit",shortcut:function(b){return a.doc.locked&&b.ctrlKey&&b.keyCode==68},shortcutDescription:"control + d",action:function(){a.duplicateDocument()}},{$where:$("#box2 .raw"),label:"Just Text",shortcut:function(a){return a.ctrlKey&&a.shiftKey&&a.keyCode==82},shortcutDescription:"control + shift + r",action:function(){window.location.href=`${a.baseUrl}raw/${a.doc.key}`}},{$where:$("#box2 .twitter"),label:"Twitter",shortcut:function(b){return a.options.twitter&&a.doc.locked&&b.shiftKey&&b.ctrlKey&&b.keyCode==84},shortcutDescription:"control + shift + t",action:function(){window.open(`https://twitter.com/share?url=${encodeURI(window.location.href)}`)}}];for(const a of this.buttons){this.configureButton(a)}}configureButton(a){a.$where.click(function(b){b.preventDefault();if(!a.clickDisabled&&$(this).hasClass("enabled")){a.action()}});a.$where.mouseenter(function(){$("#box3 .label").text(a.label);$("#box3 .shortcut").text(a.shortcutDescription||"");$("#box3").show();$(this).append($("#pointer").remove().show())});a.$where.mouseleave(function(){$("#box3").hide();$("#pointer").hide()})}configureShortcuts(){let a=this;$(document.body).keydown(function(b){for(const c of a.buttons){if(c.shortcut&&c.shortcut(b)){b.preventDefault();c.action();return}}})}}haste.extensionMap={sh:"bash",clike:"c-like",coffee:"coffeescript",cs:"csharp",dpr:"delphi",erl:"erlang",hs:"haskell",js:"javascript",kt:"kotlin",tex:"latex",lsp:"lisp",mk:"makefile",md:"markdown",mm:"objectivec",phptemp:"php-template",pl:"perl",txt:"plaintext",py:"python",pyrepl:"python-repl",rb:"ruby",rs:"rust",sc:"scala",sm:"smalltalk",ts:"typscript",vbs:"vbscript",html:"xml",htm:"xml"};$(function(){$("textarea").keydown(function(a){if(a.keyCode==9){a.preventDefault();let b="  ";if(document.selection){this.focus();let a=document.selection.createRange();a.text=b;this.focus()}else if(this.selectionStart||this.selectionStart=="0"){let a=this.selectionStart;let c=this.selectionEnd;let d=this.scrollTop;this.value=this.value.substring(0,a)+b+this.value.substring(c,this.value.length);this.focus();this.selectionStart=a+b.length;this.selectionEnd=a+b.length;this.scrollTop=d}else{this.value+=b;this.focus()}}})});
